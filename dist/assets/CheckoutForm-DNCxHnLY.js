import{j as e}from"./index-CnSDPb6a.js";import{r as i}from"./vendor-seEwQDT5.js";import{l as Z,E as $,u as W,a as X,P as V,C as M}from"./stripe-rSCYVjF0.js";import{o as I,G as _,J as ee,D as te,E as se,g as re}from"./ui-zOJd_8GS.js";const ae=Z("pk_test_51RZu15Gh7oOoHmL27KKO7KYQGjxtUeyLCQvBwWKXx9SinbzMq1cxZf9xKYRsLml3jIlHUYIU7TpZRclkTuYQiQCu00mxaB4nYH"),ne=({amount:o,productName:m,productId:L,cartItems:Y,selectedColor:A,selectedSize:O,sizeDimensions:T,customerNote:z,quantity:B=1,deliveryMethod:D="standard",deliveryFee:F=0,customerInfo:t,authToken:j,onSuccess:y,onError:u})=>{const l=W(),N=X(),[w,p]=i.useState(!1),[P,x]=i.useState("idle"),[C,c]=i.useState(""),[K,S]=i.useState(""),[E,Q]=i.useState(null),[b,U]=i.useState(!1),[d,g]=i.useState(""),[v,f]=i.useState("card");i.useEffect(()=>{if(!l)return;const r=l.paymentRequest({country:"IT",currency:"eur",total:{label:m,amount:Math.round(o*100)},requestPayerName:!0,requestPayerEmail:!0,requestPayerPhone:!0});r.canMakePayment().then(s=>{s&&(Q(r),U(!0),f("paymentRequest"))}),r.on("paymentmethod",async s=>{try{if(p(!0),x("processing"),c(""),!d){const h=await k();g(h.clientSecret)}const{error:a,paymentIntent:n}=await l.confirmCardPayment(d,{payment_method:s.paymentMethod.id,receipt_email:s.payerEmail||t.email,shipping:t.address?{name:t.name,address:{line1:t.address,city:t.city,postal_code:t.postalCode,country:"IT"},phone:t.phone}:void 0},{handleActions:!1});if(a)throw s.complete("fail"),new Error(a.message||"Payment failed");if((n==null?void 0:n.status)==="succeeded")s.complete("success"),q(n.id);else throw s.complete("fail"),new Error("Payment not completed")}catch(a){s.complete("fail"),R(a)}finally{p(!1)}})},[l,o,m,d]);const k=async()=>{G();const r={amount:Math.round(o*100),currency:"eur",productName:m,productId:L,selectedColor:A,selectedSize:O,sizeDimensions:T,customerNote:z,quantity:B,deliveryMethod:D,deliveryFee:F,cartItems:Y,customerInfo:t},s=await fetch("https://ddmkhgobkzpwlmzgxuzc.supabase.co/functions/v1/create-payment-intent",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${j}`},body:JSON.stringify(r)});if(!s.ok){const n=await s.text();throw new Error(H(n))}const a=await s.json();return g(a.clientSecret),a},G=()=>{if(!t.name||!t.email)throw new Error("Name and email are required");if(!j)throw new Error("Authentication token missing. Please login to proceed.")},H=r=>{try{return JSON.parse(r).error||"Error creating payment"}catch{return"Error creating payment"}},q=r=>{x("success"),S(r),y==null||y(r)},R=r=>{const s=r instanceof Error?r.message:"Payment failed";c(s),x("error"),u==null||u(s)},J=async r=>{if(r.preventDefault(),!l||!N){c("Stripe is not loaded yet. Please try again in a few seconds.");return}const s=N.getElement(M);if(!s){c("Card element not found");return}p(!0),x("processing"),c("");try{if(!d){const h=await k();g(h.clientSecret),S(h.orderId)}const{error:a,paymentIntent:n}=await l.confirmCardPayment(d,{payment_method:{card:s,billing_details:{name:t.name,email:t.email,phone:t.phone,address:t.address&&t.city&&t.postalCode?{line1:t.address,city:t.city,postal_code:t.postalCode,country:"IT"}:void 0}},receipt_email:t.email});if(a)throw new Error(a.message||"Payment error");if((n==null?void 0:n.status)==="succeeded")q(n.id);else throw new Error("Payment not completed")}catch(a){R(a)}finally{p(!1)}};return P==="success"?e.jsxs("div",{className:"bg-green-50 border border-green-200 rounded-lg p-8 text-center",children:[e.jsx(I,{className:"h-16 w-16 text-green-500 mx-auto mb-4"}),e.jsx("h3",{className:"text-xl font-semibold text-green-800 mb-2",children:"Payment Completed!"}),e.jsxs("p",{className:"text-green-700 mb-4",children:['Your order "',m,'" has been processed successfully.']}),e.jsxs("div",{className:"bg-white rounded-lg p-4 mb-4",children:[e.jsx("p",{className:"text-sm text-gray-600 mb-1",children:"Order Number:"}),e.jsxs("p",{className:"font-mono text-lg font-semibold text-gray-900",children:["#",K.slice(0,8)]})]}),e.jsx("p",{className:"text-sm text-green-600",children:"You'll receive a confirmation email shortly."})]}):e.jsxs("form",{onSubmit:J,className:"space-y-6",children:[e.jsxs("div",{className:"bg-blue-50 border border-blue-200 rounded-lg p-4",children:[e.jsxs("div",{className:"flex items-center space-x-2 mb-2",children:[e.jsx(_,{className:"h-5 w-5 text-blue-600"}),e.jsx("span",{className:"font-medium text-blue-800",children:"Secure Payment"})]}),e.jsx("p",{className:"text-sm text-blue-700",children:"Your data is protected with 256-bit SSL encryption"})]}),e.jsxs("div",{className:"space-y-4",children:[e.jsx("h3",{className:"font-semibold text-gray-900",children:"Payment Method"}),b&&E&&v==="paymentRequest"&&e.jsxs("div",{className:"bg-white border border-gray-300 rounded-lg p-4",children:[e.jsxs("div",{className:"flex items-center space-x-2 mb-4",children:[e.jsx(ee,{className:"h-5 w-5 text-gray-600"}),e.jsx("span",{className:"font-medium text-gray-900",children:"Quick Payment"})]}),e.jsx(V,{options:{paymentRequest:E,style:{paymentRequestButton:{type:"buy",theme:"dark",height:"48px"}}}}),e.jsx("div",{className:"mt-4 pt-4 border-t border-gray-200 text-center",children:e.jsx("button",{type:"button",onClick:()=>f("card"),className:"text-sm text-blue-600 hover:text-blue-800",children:"Use credit/debit card instead"})})]}),(v==="card"||!b)&&e.jsxs("div",{className:"bg-white border border-gray-300 rounded-lg p-4",children:[e.jsxs("div",{className:"flex items-center space-x-2 mb-4",children:[e.jsx(te,{className:"h-5 w-5 text-gray-600"}),e.jsx("span",{className:"font-medium text-gray-900",children:"Credit/Debit Card"})]}),e.jsx("div",{className:"p-4 border border-gray-200 rounded-lg bg-white",children:e.jsx(M,{options:{style:{base:{fontSize:"16px",color:"#1f2937",backgroundColor:"#ffffff",fontFamily:"Inter, system-ui, sans-serif","::placeholder":{color:"#9ca3af"}},invalid:{color:"#ef4444",iconColor:"#ef4444"}},hidePostalCode:!0}})}),b&&e.jsx("div",{className:"mt-4 pt-4 border-t border-gray-200 text-center",children:e.jsx("button",{type:"button",onClick:()=>f("paymentRequest"),className:"text-sm text-blue-600 hover:text-blue-800",children:"Use Apple Pay/Google Pay instead"})})]})]}),C&&e.jsxs("div",{className:"bg-red-50 border border-red-200 rounded-lg p-4 flex items-start space-x-3",children:[e.jsx(se,{className:"h-5 w-5 text-red-500 mt-0.5"}),e.jsxs("div",{children:[e.jsx("h4",{className:"font-medium text-red-800",children:"Payment Error"}),e.jsx("p",{className:"text-sm text-red-700",children:C})]})]}),e.jsx("button",{type:"submit",disabled:!l||w||P==="processing",className:"w-full bg-blue-600 hover:bg-blue-700 disabled:bg-blue-400 text-white py-4 px-6 rounded-lg font-semibold transition-colors duration-200 flex items-center justify-center space-x-2",children:w?e.jsxs(e.Fragment,{children:[e.jsx(re,{className:"h-5 w-5 animate-spin"}),e.jsx("span",{children:"Processing..."})]}):e.jsxs(e.Fragment,{children:[e.jsx(_,{className:"h-5 w-5"}),e.jsxs("span",{children:["Pay â‚¬",o.toFixed(2)]})]})}),e.jsx("p",{className:"text-xs text-gray-500 text-center",children:'By clicking "Pay" you agree to our terms of service and privacy policy'})]})},de=o=>e.jsx($,{stripe:ae,children:e.jsx(ne,{...o})});export{de as C};
