import{j as e}from"./index-DUfOYqed.js";import{r as n}from"./vendor-seEwQDT5.js";import{l as I,E as ee,u as te,a as se,P as re,C as Y}from"./stripe-rSCYVjF0.js";import{x as ae,D as z,E as ne,z as ie,B as le,g as ce}from"./ui-BkBIl3wn.js";const oe=I("pk_test_51RZu15Gh7oOoHmL27KKO7KYQGjxtUeyLCQvBwWKXx9SinbzMq1cxZf9xKYRsLml3jIlHUYIU7TpZRclkTuYQiQCu00mxaB4nYH"),de=({amount:o,productName:d,productId:A,cartItems:B,selectedColor:O,selectedSize:T,sizeDimensions:D,customerNote:F,quantity:K=1,deliveryMethod:Q="standard",deliveryFee:U=0,customerInfo:t,authToken:w,onSuccess:u,onError:h})=>{const l=te(),N=se(),[y,m]=n.useState(!1),[b,P]=n.useState(!1),[C,p]=n.useState("idle"),[E,x]=n.useState(""),[G,H]=n.useState(""),[v,Z]=n.useState(null),[g,J]=n.useState(!1),[S,f]=n.useState(""),[k,j]=n.useState("card"),R=n.useRef(!1),q=n.useRef(!1);n.useEffect(()=>{if(!l)return;const a=l.paymentRequest({country:"IT",currency:"eur",total:{label:d,amount:Math.round(o*100)},requestPayerName:!0,requestPayerEmail:!0,requestPayerPhone:!0});a.canMakePayment().then(r=>{r&&(Z(a),J(!0),j("paymentRequest"))}),a.on("paymentmethod",async r=>{try{m(!0),p("processing"),x(""),q.current=!0;let s=S;if(s||(s=(await _()).clientSecret,f(s)),!s||!s.includes("_secret_"))throw new Error("Invalid client secret format");const{error:c,paymentIntent:i}=await l.confirmCardPayment(s,{payment_method:r.paymentMethod.id,receipt_email:r.payerEmail||t.email,shipping:t.address?{name:t.name,address:{line1:t.address,city:t.city,postal_code:t.postalCode,country:"IT"},phone:t.phone}:void 0},{handleActions:!1});if(c)throw r.complete("fail"),new Error(c.message||"Payment failed");if((i==null?void 0:i.status)==="succeeded")r.complete("success"),M(i.id);else throw r.complete("fail"),new Error("Payment not completed")}catch(s){r.complete("fail"),L(s)}finally{m(!1),q.current=!1}})},[l,o,d]);const _=async()=>{$(),P(!0);try{const a={amount:Math.round(o*100),currency:"eur",productName:d,productId:A,selectedColor:O,selectedSize:T,sizeDimensions:D,customerNote:F,quantity:K,deliveryMethod:Q,deliveryFee:U,cartItems:B,customerInfo:t},r=await fetch("https://ddmkhgobkzpwlmzgxuzc.supabase.co/functions/v1/create-payment-intent",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${w}`},body:JSON.stringify(a)});if(!r.ok){const c=await r.text();throw new Error(W(c))}const s=await r.json();return f(s.clientSecret),R.current=!0,s}finally{P(!1)}},$=()=>{if(!t.name||!t.email)throw new Error("Name and email are required");if(!w)throw new Error("Authentication token missing. Please login to proceed.")},W=a=>{try{return JSON.parse(a).error||"Error creating payment"}catch{return"Error creating payment"}},M=a=>{p("success"),H(a),u==null||u(a)},L=a=>{const r=a instanceof Error?a.message:"Payment failed";x(r),p("error"),h==null||h(r)},X=async a=>{if(a.preventDefault(),!l||!N||y||b)return;const r=N.getElement(Y);if(!r){x("Card element not found");return}m(!0),p("processing"),x("");try{let s=S;if(!s&&!R.current&&(s=(await _()).clientSecret,f(s)),!s||!s.includes("_secret_"))throw new Error("Invalid client secret format");const{error:c,paymentIntent:i}=await l.confirmCardPayment(s,{payment_method:{card:r,billing_details:{name:t.name,email:t.email,phone:t.phone,address:t.address&&t.city&&t.postalCode?{line1:t.address,city:t.city,postal_code:t.postalCode,country:"IT"}:void 0}},receipt_email:t.email});if(c)throw new Error(c.message||"Payment error");if((i==null?void 0:i.status)==="succeeded")M(i.id);else throw new Error("Payment not completed")}catch(s){L(s)}finally{m(!1)}};return C==="success"?e.jsxs("div",{className:"bg-green-50 border border-green-200 rounded-lg p-8 text-center",children:[e.jsx(ae,{className:"h-16 w-16 text-green-500 mx-auto mb-4"}),e.jsx("h3",{className:"text-xl font-semibold text-green-800 mb-2",children:"Payment Completed!"}),e.jsxs("p",{className:"text-green-700 mb-4",children:['Your order "',d,'" has been processed successfully.']}),e.jsxs("div",{className:"bg-white rounded-lg p-4 mb-4",children:[e.jsx("p",{className:"text-sm text-gray-600 mb-1",children:"Order Number:"}),e.jsxs("p",{className:"font-mono text-lg font-semibold text-gray-900",children:["#",G.slice(0,8)]})]}),e.jsx("p",{className:"text-sm text-green-600",children:"You'll receive a confirmation email shortly."})]}):e.jsxs("form",{onSubmit:X,className:"space-y-6",children:[e.jsxs("div",{className:"bg-blue-50 border border-blue-200 rounded-lg p-4",children:[e.jsxs("div",{className:"flex items-center space-x-2 mb-2",children:[e.jsx(z,{className:"h-5 w-5 text-blue-600"}),e.jsx("span",{className:"font-medium text-blue-800",children:"Secure Payment"})]}),e.jsx("p",{className:"text-sm text-blue-700",children:"Your data is protected with 256-bit SSL encryption"})]}),e.jsxs("div",{className:"space-y-4",children:[e.jsx("h3",{className:"font-semibold text-gray-900",children:"Payment Method"}),g&&v&&k==="paymentRequest"&&e.jsxs("div",{className:"bg-white border border-gray-300 rounded-lg p-4",children:[e.jsxs("div",{className:"flex items-center space-x-2 mb-4",children:[e.jsx(ne,{className:"h-5 w-5 text-gray-600"}),e.jsx("span",{className:"font-medium text-gray-900",children:"Quick Payment"})]}),e.jsx(re,{options:{paymentRequest:v,style:{paymentRequestButton:{type:"buy",theme:"dark",height:"48px"}}}}),e.jsx("div",{className:"mt-4 pt-4 border-t border-gray-200 text-center",children:e.jsx("button",{type:"button",onClick:()=>j("card"),className:"text-sm text-blue-600 hover:text-blue-800",children:"Use credit/debit card instead"})})]}),(k==="card"||!g)&&e.jsxs("div",{className:"bg-white border border-gray-300 rounded-lg p-4",children:[e.jsxs("div",{className:"flex items-center space-x-2 mb-4",children:[e.jsx(ie,{className:"h-5 w-5 text-gray-600"}),e.jsx("span",{className:"font-medium text-gray-900",children:"Credit/Debit Card"})]}),e.jsx("div",{className:"p-4 border border-gray-200 rounded-lg bg-white",children:e.jsx(Y,{options:{style:{base:{fontSize:"16px",color:"#1f2937",backgroundColor:"#ffffff",fontFamily:"Inter, system-ui, sans-serif","::placeholder":{color:"#9ca3af"}},invalid:{color:"#ef4444",iconColor:"#ef4444"}},hidePostalCode:!0}})}),g&&e.jsx("div",{className:"mt-4 pt-4 border-t border-gray-200 text-center",children:e.jsx("button",{type:"button",onClick:()=>j("paymentRequest"),className:"text-sm text-blue-600 hover:text-blue-800",children:"Use Apple Pay/Google Pay instead"})})]})]}),E&&e.jsxs("div",{className:"bg-red-50 border border-red-200 rounded-lg p-4 flex items-start space-x-3",children:[e.jsx(le,{className:"h-5 w-5 text-red-500 mt-0.5"}),e.jsxs("div",{children:[e.jsx("h4",{className:"font-medium text-red-800",children:"Payment Error"}),e.jsx("p",{className:"text-sm text-red-700",children:E})]})]}),e.jsx("button",{type:"submit",disabled:!l||y||b||C==="processing",className:"w-full bg-blue-600 hover:bg-blue-700 disabled:bg-blue-400 text-white py-4 px-6 rounded-lg font-semibold transition-colors duration-200 flex items-center justify-center space-x-2",children:y||b?e.jsxs(e.Fragment,{children:[e.jsx(ce,{className:"h-5 w-5 animate-spin"}),e.jsx("span",{children:"Processing..."})]}):e.jsxs(e.Fragment,{children:[e.jsx(z,{className:"h-5 w-5"}),e.jsxs("span",{children:["Pay â‚¬",o.toFixed(2)]})]})}),e.jsx("p",{className:"text-xs text-gray-500 text-center",children:'By clicking "Pay" you agree to our terms of service and privacy policy'})]})},he=o=>e.jsx(ee,{stripe:oe,children:e.jsx(de,{...o})});export{he as C};
