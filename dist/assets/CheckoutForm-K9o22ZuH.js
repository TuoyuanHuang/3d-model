import{j as e}from"./index-CVmCnHMs.js";import{r as p,a as T}from"./vendor-seEwQDT5.js";import{l as B,E as _,u as K,a as Y,P as D,C as v}from"./stripe-rSCYVjF0.js";import{o as Q,x as E,z as U,y as A,B as H}from"./ui-g5MN1jGh.js";const Z=B("pk_test_51RZu15Gh7oOoHmL27KKO7KYQGjxtUeyLCQvBwWKXx9SinbzMq1cxZf9xKYRsLml3jIlHUYIU7TpZRclkTuYQiQCu00mxaB4nYH"),G=({amount:l,productName:h,productId:S,cartItems:k,selectedColor:R,quantity:z=1,customerInfo:s,authToken:y,onSuccess:c,onError:d})=>{const o=K(),f=Y(),[b,u]=p.useState(!1),[j,m]=p.useState("idle"),[w,x]=p.useState(""),[q,N]=p.useState(""),[P,M]=p.useState(null),[F,L]=p.useState(!1);T.useEffect(()=>{if(o){const i=o.paymentRequest({country:"IT",currency:"eur",total:{label:h,amount:Math.round(l*100)},requestPayerName:!0,requestPayerEmail:!0,requestPayerPhone:!0});i.canMakePayment().then(r=>{r&&(M(i),L(!0))}),i.on("paymentmethod",async r=>{try{u(!0),m("processing"),x("");const t=await C();if(!t.clientSecret)throw new Error("Failed to create payment intent");const{error:a,paymentIntent:n}=await o.confirmCardPayment(t.clientSecret,{payment_method:r.paymentMethod.id},{handleActions:!1});if(a)throw r.complete("fail"),new Error(a.message||"Payment failed");if((n==null?void 0:n.status)==="succeeded")r.complete("success"),m("success"),N(t.orderId),c==null||c(t.orderId);else throw r.complete("fail"),new Error("Payment not completed")}catch(t){r.complete("fail");const a=t instanceof Error?t.message:"Payment failed";x(a),m("error"),d==null||d(a)}finally{u(!1)}})}},[o,l,h]);const C=async()=>{if(!s.name||!s.email)throw new Error("Nome e email sono obbligatori");if(!y)throw new Error("Token di autenticazione mancante. Effettua il login per continuare.");const i="https://ddmkhgobkzpwlmzgxuzc.supabase.co",r={amount:Math.round(l*100),currency:"eur",productName:h,productId:S,selectedColor:R,quantity:z,cartItems:k,customerInfo:s};console.log("Creating payment intent with data:",r);const t=await fetch(`${i}/functions/v1/create-payment-intent`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${y}`},body:JSON.stringify(r)});if(!t.ok){const n=await t.text();console.error("Payment intent creation failed:",n);let g;try{g=JSON.parse(n)}catch{g={error:"Errore nella creazione del pagamento"}}throw new Error(g.error||"Errore nella creazione del pagamento")}const a=await t.json();return console.log("Payment intent created successfully:",a),a},O=async i=>{if(i.preventDefault(),!o||!f){x("Stripe non è ancora caricato. Riprova tra qualche secondo.");return}const r=f.getElement(v);if(!r){x("Elemento carta non trovato");return}u(!0),m("processing"),x("");try{const t=await C();N(t.orderId);const{error:a,paymentIntent:n}=await o.confirmCardPayment(t.clientSecret,{payment_method:{card:r,billing_details:{name:s.name,email:s.email,phone:s.phone,address:s.address&&s.city&&s.postalCode?{line1:s.address,city:s.city,postal_code:s.postalCode,country:"IT"}:void 0}}});if(a)throw new Error(a.message||"Errore durante il pagamento");if((n==null?void 0:n.status)==="succeeded")m("success"),c==null||c(t.orderId);else throw new Error("Pagamento non completato")}catch(t){const a=t instanceof Error?t.message:"Errore durante il pagamento";console.error("Payment error:",t),x(a),m("error"),d==null||d(a)}finally{u(!1)}};return j==="success"?e.jsxs("div",{className:"bg-green-50 border border-green-200 rounded-lg p-8 text-center",children:[e.jsx(Q,{className:"h-16 w-16 text-green-500 mx-auto mb-4"}),e.jsx("h3",{className:"text-xl font-semibold text-green-800 mb-2",children:"Pagamento Completato!"}),e.jsxs("p",{className:"text-green-700 mb-4",children:['Il tuo ordine "',h,'" è stato processato con successo.']}),e.jsxs("div",{className:"bg-white rounded-lg p-4 mb-4",children:[e.jsx("p",{className:"text-sm text-gray-600 mb-1",children:"Numero Ordine:"}),e.jsxs("p",{className:"font-mono text-lg font-semibold text-gray-900",children:["#",q.slice(0,8)]})]}),e.jsx("p",{className:"text-sm text-green-600",children:"Riceverai una conferma via email a breve."})]}):e.jsxs("form",{onSubmit:O,className:"space-y-6",children:[e.jsxs("div",{className:"bg-blue-50 border border-blue-200 rounded-lg p-4",children:[e.jsxs("div",{className:"flex items-center space-x-2 mb-2",children:[e.jsx(E,{className:"h-5 w-5 text-blue-600"}),e.jsx("span",{className:"font-medium text-blue-800",children:"Pagamento Sicuro"})]}),e.jsx("p",{className:"text-sm text-blue-700",children:"I tuoi dati sono protetti con crittografia SSL a 256 bit"})]}),e.jsxs("div",{className:"space-y-4",children:[e.jsx("h3",{className:"font-semibold text-gray-900",children:"Metodo di Pagamento"}),F&&P&&e.jsxs("div",{className:"bg-white border border-gray-300 rounded-lg p-4",children:[e.jsxs("div",{className:"flex items-center space-x-2 mb-4",children:[e.jsx(U,{className:"h-5 w-5 text-gray-600"}),e.jsx("span",{className:"font-medium text-gray-900",children:"Pagamento Rapido"})]}),e.jsx(D,{options:{paymentRequest:P,style:{paymentRequestButton:{type:"buy",theme:"dark",height:"48px"}}}}),e.jsx("div",{className:"mt-4 text-center",children:e.jsx("span",{className:"text-sm text-gray-500",children:"oppure"})})]}),e.jsxs("div",{className:"bg-white border border-gray-300 rounded-lg p-4",children:[e.jsxs("div",{className:"flex items-center space-x-2 mb-4",children:[e.jsx(A,{className:"h-5 w-5 text-gray-600"}),e.jsx("span",{className:"font-medium text-gray-900",children:"Carta di Credito/Debito"})]}),e.jsx("div",{className:"p-4 border border-gray-200 rounded-lg bg-white",children:e.jsx(v,{options:{style:{base:{fontSize:"16px",color:"#1f2937",backgroundColor:"#ffffff",fontFamily:"Inter, system-ui, sans-serif",fontSmoothing:"antialiased","::placeholder":{color:"#9ca3af"},":-webkit-autofill":{color:"#1f2937"}},invalid:{color:"#ef4444",iconColor:"#ef4444"},complete:{color:"#059669",iconColor:"#059669"}},hidePostalCode:!0,iconStyle:"solid"}})})]})]}),w&&e.jsxs("div",{className:"bg-red-50 border border-red-200 rounded-lg p-4 flex items-start space-x-3",children:[e.jsx(H,{className:"h-5 w-5 text-red-500 mt-0.5"}),e.jsxs("div",{children:[e.jsx("h4",{className:"font-medium text-red-800",children:"Errore nel Pagamento"}),e.jsx("p",{className:"text-sm text-red-700",children:w})]})]}),e.jsx("button",{type:"submit",disabled:!o||b||j==="processing",className:"w-full bg-blue-600 hover:bg-blue-700 disabled:bg-blue-400 text-white py-4 px-6 rounded-lg font-semibold transition-colors duration-200 flex items-center justify-center space-x-2",children:b?e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"animate-spin rounded-full h-5 w-5 border-b-2 border-white"}),e.jsx("span",{children:"Elaborazione..."})]}):e.jsxs(e.Fragment,{children:[e.jsx(E,{className:"h-5 w-5"}),e.jsxs("span",{children:["Paga €",l.toFixed(2)]})]})}),e.jsx("p",{className:"text-xs text-gray-500 text-center",children:'Cliccando "Paga" accetti i nostri termini di servizio e la privacy policy'})]})},X=l=>e.jsx(_,{stripe:Z,children:e.jsx(G,{...l})});export{X as C};
