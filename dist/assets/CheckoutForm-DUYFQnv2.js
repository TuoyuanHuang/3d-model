import{j as e}from"./index-uCfaxT6h.js";import{r as i}from"./vendor-seEwQDT5.js";import{l as $,E as W,u as X,a as V,P as I,C as _}from"./stripe-rSCYVjF0.js";import{D as ee,E as te,y as se,z as re,g as ae,B as ne}from"./ui-CrNHFUv9.js";const ie=$("pk_test_51RZu15Gh7oOoHmL27KKO7KYQGjxtUeyLCQvBwWKXx9SinbzMq1cxZf9xKYRsLml3jIlHUYIU7TpZRclkTuYQiQCu00mxaB4nYH"),le=({amount:o,productName:d,productId:z,cartItems:A,selectedColor:B,selectedSize:L,sizeDimensions:O,customerNote:T,quantity:Y=1,deliveryMethod:D="standard",deliveryFee:F=0,customerInfo:t,authToken:j,onSuccess:x,onError:u})=>{const l=X(),P=V(),[w,m]=i.useState(!1),[N,p]=i.useState("idle"),[C,c]=i.useState(""),[K,Q]=i.useState(""),[E,U]=i.useState(null),[h,G]=i.useState(!1),[y,g]=i.useState(""),[S,b]=i.useState("card"),v=i.useRef(!1),k=i.useRef(!1);i.useEffect(()=>{if(!l)return;const r=l.paymentRequest({country:"IT",currency:"eur",total:{label:d,amount:Math.round(o*100)},requestPayerName:!0,requestPayerEmail:!0,requestPayerPhone:!0});r.canMakePayment().then(s=>{s&&(U(r),G(!0),b("paymentRequest"))}),r.on("paymentmethod",async s=>{try{if(m(!0),p("processing"),c(""),k.current=!0,!y){const f=await R();g(f.clientSecret)}const{error:a,paymentIntent:n}=await l.confirmCardPayment(y,{payment_method:s.paymentMethod.id,receipt_email:s.payerEmail||t.email,shipping:t.address?{name:t.name,address:{line1:t.address,city:t.city,postal_code:t.postalCode,country:"IT"},phone:t.phone}:void 0},{handleActions:!1});if(a)throw s.complete("fail"),new Error(a.message||"Payment failed");if((n==null?void 0:n.status)==="succeeded")s.complete("success"),q(n.id);else throw s.complete("fail"),new Error("Payment not completed")}catch(a){s.complete("fail"),M(a)}finally{m(!1),k.current=!1}})},[l,o,d]);const R=async()=>{H();const r={amount:Math.round(o*100),currency:"eur",productName:d,productId:z,selectedColor:B,selectedSize:L,sizeDimensions:O,customerNote:T,quantity:Y,deliveryMethod:D,deliveryFee:F,cartItems:A,customerInfo:t},s=await fetch("https://ddmkhgobkzpwlmzgxuzc.supabase.co/functions/v1/create-payment-intent",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${j}`},body:JSON.stringify(r)});if(!s.ok){const n=await s.text();throw new Error(Z(n))}const a=await s.json();return g(a.clientSecret),v.current=!0,a},H=()=>{if(!t.name||!t.email)throw new Error("Name and email are required");if(!j)throw new Error("Authentication token missing. Please login to proceed.")},Z=r=>{try{return JSON.parse(r).error||"Error creating payment"}catch{return"Error creating payment"}},q=r=>{p("success"),Q(r),x==null||x(r)},M=r=>{const s=r instanceof Error?r.message:"Payment failed";c(s),p("error"),u==null||u(s)},J=async r=>{if(r.preventDefault(),!l||!P){c("Stripe is not loaded yet. Please try again in a few seconds.");return}const s=P.getElement(_);if(!s){c("Card element not found");return}m(!0),p("processing"),c("");try{if(!y&&!v.current){const f=await R();g(f.clientSecret)}const{error:a,paymentIntent:n}=await l.confirmCardPayment(y,{payment_method:{card:s,billing_details:{name:t.name,email:t.email,phone:t.phone,address:t.address&&t.city&&t.postalCode?{line1:t.address,city:t.city,postal_code:t.postalCode,country:"IT"}:void 0}},receipt_email:t.email});if(a)throw new Error(a.message||"Payment error");if((n==null?void 0:n.status)==="succeeded")q(n.id);else throw new Error("Payment not completed")}catch(a){M(a)}finally{m(!1)}};return N==="success"?e.jsxs("div",{className:"bg-green-50 border border-green-200 rounded-lg p-8 text-center",children:[e.jsx(ee,{className:"h-16 w-16 text-green-500 mx-auto mb-4"}),e.jsx("h3",{className:"text-xl font-semibold text-green-800 mb-2",children:"Payment Completed!"}),e.jsxs("p",{className:"text-green-700 mb-4",children:['Your order "',d,'" has been processed successfully.']}),e.jsxs("div",{className:"bg-white rounded-lg p-4 mb-4",children:[e.jsx("p",{className:"text-sm text-gray-600 mb-1",children:"Order Number:"}),e.jsxs("p",{className:"font-mono text-lg font-semibold text-gray-900",children:["#",K.slice(0,8)]})]}),e.jsx("p",{className:"text-sm text-green-600",children:"You'll receive a confirmation email shortly."})]}):e.jsxs("form",{onSubmit:J,className:"space-y-6",children:[e.jsxs("div",{className:"space-y-4",children:[e.jsx("h3",{className:"font-semibold text-gray-900",children:"Payment Method"}),h&&E&&S==="paymentRequest"&&e.jsxs("div",{className:"bg-white border border-gray-300 rounded-lg p-4",children:[e.jsxs("div",{className:"flex items-center space-x-2 mb-4",children:[e.jsx(te,{className:"h-5 w-5 text-gray-600"}),e.jsx("span",{className:"font-medium text-gray-900",children:"Quick Payment"})]}),e.jsx(I,{options:{paymentRequest:E,style:{paymentRequestButton:{type:"buy",theme:"dark",height:"48px"}}}}),e.jsx("div",{className:"mt-4 pt-4 border-t border-gray-200 text-center",children:e.jsx("button",{type:"button",onClick:()=>b("card"),className:"text-sm text-blue-600 hover:text-blue-800",children:"Use credit/debit card instead"})})]}),(S==="card"||!h)&&e.jsxs("div",{className:"bg-white border border-gray-300 rounded-lg p-4",children:[e.jsxs("div",{className:"flex items-center space-x-2 mb-4",children:[e.jsx(se,{className:"h-5 w-5 text-gray-600"}),e.jsx("span",{className:"font-medium text-gray-900",children:"Credit/Debit Card"})]}),e.jsx("div",{className:"p-4 border border-gray-200 rounded-lg bg-white",children:e.jsx(_,{options:{style:{base:{fontSize:"16px",color:"#1f2937",backgroundColor:"#ffffff",fontFamily:"Inter, system-ui, sans-serif","::placeholder":{color:"#9ca3af"}},invalid:{color:"#ef4444",iconColor:"#ef4444"}},hidePostalCode:!0}})}),h&&e.jsx("div",{className:"mt-4 pt-4 border-t border-gray-200 text-center",children:e.jsx("button",{type:"button",onClick:()=>b("paymentRequest"),className:"text-sm text-blue-600 hover:text-blue-800",children:"Use Apple Pay/Google Pay instead"})})]})]}),C&&e.jsxs("div",{className:"bg-red-50 border border-red-200 rounded-lg p-4 flex items-start space-x-3",children:[e.jsx(re,{className:"h-5 w-5 text-red-500 mt-0.5"}),e.jsxs("div",{children:[e.jsx("h4",{className:"font-medium text-red-800",children:"Payment Error"}),e.jsx("p",{className:"text-sm text-red-700",children:C})]})]}),e.jsx("button",{type:"submit",disabled:!l||w||N==="processing",className:"w-full bg-blue-600 hover:bg-blue-700 disabled:bg-blue-400 text-white py-4 px-6 rounded-lg font-semibold transition-colors duration-200 flex items-center justify-center space-x-2",children:w?e.jsxs(e.Fragment,{children:[e.jsx(ae,{className:"h-5 w-5 animate-spin"}),e.jsx("span",{children:"Processing..."})]}):e.jsxs(e.Fragment,{children:[e.jsx(ne,{className:"h-5 w-5"}),e.jsxs("span",{children:["Pay â‚¬",o.toFixed(2)]})]})}),e.jsx("p",{className:"text-xs text-gray-500 text-center",children:'By clicking "Pay" you agree to our terms of service and privacy policy'})]})},pe=o=>e.jsx(W,{stripe:ie,children:e.jsx(le,{...o})});export{pe as C};
